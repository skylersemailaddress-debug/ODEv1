name: ODE Autoprogram

on:
  workflow_dispatch:
    inputs:
      dbs_path:
        description: "Path to DBS markdown"
        required: true
        default: "dbs/MASTER_DBS.md"
      abi_path:
        description: "Path to ABI JSON"
        required: true
        default: "examples/ABI_TEMPLATE.json"
  push:
    paths: ["dbs/**","tools/**","src/**","examples/**",".github/workflows/ode_autoprogram.yml",".github/workflows/ode_automerge_green.yml"]
  pull_request:
    paths: ["dbs/**","tools/**","src/**","examples/**",".github/workflows/ode_autoprogram.yml",".github/workflows/ode_automerge_green.yml"]

permissions:
  contents: write
  pull-requests: write

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Refresh DBS sha (workspace)
        shell: pwsh
        run: |
          $ErrorActionPreference="Stop"
          $ProgressPreference="SilentlyContinue"
          pwsh -NoProfile -File tools/dev/REFRESH_DBS_SHA.ps1 `
            -Path "${{ inputs.dbs_path || 'dbs/MASTER_DBS.md' }}" `
            -InPlace
          git status --porcelain

      - name: Auto-commit refreshed DBS sha (push only)
        if: github.event_name == 'push'
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "chore(dbs): refresh declared sha256 [skip ci]"
          file_pattern: "dbs/**/*.md"

      - name: Gates (fail-closed)
        shell: pwsh
        run: |
          $ErrorActionPreference="Stop"
          $ProgressPreference="SilentlyContinue"
          pwsh -NoProfile -File tools/gates/RUN_ALL_GATES.ps1 `
            -DBS "${{ inputs.dbs_path || 'dbs/MASTER_DBS.md' }}" `
            -ABI "${{ inputs.abi_path || 'examples/ABI_TEMPLATE.json' }}"

      - name: Compile (DBS -> DBP)
        shell: pwsh
        run: |
          $ErrorActionPreference="Stop"
          $ProgressPreference="SilentlyContinue"
          pwsh -NoProfile -File tools/run/RUN_COMPILE.ps1 `
            -DBS "${{ inputs.dbs_path || 'dbs/MASTER_DBS.md' }}" `
            -ABI "${{ inputs.abi_path || 'examples/ABI_TEMPLATE.json' }}"

      - name: Execute (DBP)
        run: python src/executor/run_dbp.py --dbp out/DBP.json

      - name: Upload proof artifacts
        uses: actions/upload-artifact@v4
        with:
          name: ode_build_${{ github.sha }}
          path: out/**
