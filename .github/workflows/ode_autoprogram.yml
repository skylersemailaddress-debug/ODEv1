name: ODE Autoprogram

on:
  pull_request:
    branches: [ "main" ]
  workflow_dispatch:

permissions:
  contents: write
  pull-requests: write

jobs:
  build:
    name: ODE Autoprogram
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Assert gh CLI available
        shell: bash
        run: |
          set -euo pipefail
          command -v gh >/dev/null 2>&1 || { echo "FATAL: gh CLI not found on runner"; exit 1; }
          gh --version

      - name: Auto-refresh DBS SHA (open PR if needed)
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        shell: bash
        run: |
          set -euo pipefail

          pwsh -NoProfile -File tools/dev/REFRESH_DBS_SHA.ps1 -Path dbs/MASTER_DBS.md -InPlace

          if git diff --quiet; then
            echo "DBS_SHA_REFRESH_PR_NEEDED=0" >> $GITHUB_ENV
            exit 0
          fi

          echo "DBS_SHA_REFRESH_PR_NEEDED=1" >> $GITHUB_ENV

          BRANCH="robot/refresh-dbs-sha-$(date +%Y%m%d-%H%M%S)"
          git checkout -b "$BRANCH"
          git add dbs/MASTER_DBS.md
          git -c user.name="ode-robot" -c user.email="actions@users.noreply.github.com" commit -m "chore(dbs): refresh frontmatter sha256"
          git push origin "$BRANCH"

          PR_URL=$(gh pr create \
            --title "chore(dbs): refresh frontmatter sha256" \
            --body "Robot refresh: DBS file changed; updating frontmatter sha256 to match content." \
            --base main \
            --head "$BRANCH" \
            || true)

          echo "PR_URL=$PR_URL"

          if [ -n "$PR_URL" ]; then
            gh pr merge "$PR_URL" --squash --auto --delete-branch || true
          fi

          echo "Opened PR to refresh DBS SHA. Stopping current run."
          exit 0

      - name: Gates (fail-closed)
        shell: bash
        run: |
          set -euo pipefail
          pwsh -NoProfile -File tools/gates/RUN_ALL_GATES.ps1 \
            -DBS "dbs/MASTER_DBS.md" \
            -ABI "examples/ABI_TEMPLATE.json"
